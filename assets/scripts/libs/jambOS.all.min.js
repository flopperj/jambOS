var jambOS=jambOS||{version:"1.0"};jambOS.util={};jambOS.OS={};jambOS.host={};(function(){var g=Array.prototype.slice,f=function(){};var d=(function(){for(var h in {toString:1}){if(h==="toString"){return false}}return true})();var c=function(h,k,i){for(var j in k){if(j in h.prototype&&typeof h.prototype[j]==="function"&&(k[j]+"").indexOf("callSuper")>-1){h.prototype[j]=(function(l){return function(){var n=this.constructor.superclass;this.constructor.superclass=i;var m=k[l].apply(this,arguments);this.constructor.superclass=n;if(l!=="initialize"){return m}}})(j)}else{h.prototype[j]=k[j]}if(d){if(k.toString!==Object.prototype.toString){h.prototype.toString=k.toString}if(k.valueOf!==Object.prototype.valueOf){h.prototype.valueOf=k.valueOf}}}};function b(){}function a(h){var i=this.constructor.superclass.prototype[h];return(arguments.length>1)?i.apply(this,g.call(arguments,1)):i.call(this)}function e(){var l=null,k=g.call(arguments,0);if(typeof k[0]==="function"){l=k.shift()}function h(){this.initialize.apply(this,arguments)}h.superclass=l;h.subclasses=[];if(l){b.prototype=l.prototype;h.prototype=new b();l.subclasses.push(h)}for(var j=0,m=k.length;j<m;j++){c(h,k[j],l)}if(!h.prototype.initialize){h.prototype.initialize=f}h.prototype.constructor=h;h.prototype.callSuper=a;h.prototype.type=h.prototype.type?h.prototype.type:"Klass";h.prototype.toString=function(){return"#<jambOS."+this.type.capitalize()+">"};h.prototype.get=function(i){return this[i]};h.prototype.set=function(i,n){if(typeof i==="object"){for(var o in i){this._set(o,i[o])}}else{if(typeof n==="function"){this._set(i,n(this.get(i)))}else{this._set(i,n)}}return this};h.prototype._set=function(i,n){this[i]=n;return this};h.prototype.setOptions=function(i){for(var n in i){this.set(n,i[n])}return this};return h}jambOS.util.createClass=e})();$(document).ready(function(){_Control=new jambOS.host.Control()});function trim(a){return a.replace(/^\s+ | \s+$/g,"")}function rot13(e){var d="";for(var a in e){var b=e[a];var c=0;if("abcedfghijklmABCDEFGHIJKLM".indexOf(b)>=0){c=e.charCodeAt(a)+13;d=d+String.fromCharCode(c)}else{if("nopqrstuvwxyzNOPQRSTUVWXYZ".indexOf(b)>=0){c=e.charCodeAt(a)-13;d=d+String.fromCharCode(c)}else{d=d+b}}}return d}var APP_NAME="JambOS";var APP_VERSION="1.00";var CPU_CLOCK_INTERVAL=100;var TIMER_IRQ=0;var KEYBOARD_IRQ=1;var _CPU=null;var _OSclock=0;var _Mode=0;var _Canvas=null;var _TaskbarCanvas=null;var _DrawingContext=null;var _TaskbarContext=null;var _DefaultFontFamily="sans";var _DefaultFontSize=13;var _FontHeightMargin=4;var _Trace=true;var _KernelInterruptQueue=null;var _KernelBuffers=null;var _KernelInputQueue=null;var _StdIn=null;var _StdOut=null;var _Console=null;var _OsShell=null;var _SarcasticMode=false;var _Kernel=null;_Control=null;var _GLaDOS=null;var _CommandHistory=[];var _CurrentCommandIndex=-1;krnInterruptHandler=null;jambOS.host.Control=jambOS.util.createClass({initialize:function(){var a=this;_Kernel=new jambOS.OS.Kernel();_Canvas=document.getElementById("display");_Canvas.width=$("#divConsole").width()-10;_TaskbarCanvas=document.createElement("canvas");_TaskbarCanvas.id="taskbar";_TaskbarCanvas.width=$("#divConsole").width()-10;_TaskbarCanvas.height=22;_TaskbarCanvas.style.zIndex=8;_TaskbarCanvas.style.position="absolute";_TaskbarCanvas.style.borderBottom="2px solid #000000";_TaskbarCanvas.style.background="#DFDBC3";document.getElementById("divConsole").insertBefore(_TaskbarCanvas,_Canvas);_DrawingContext=_Canvas.getContext("2d");_TaskbarContext=_TaskbarCanvas.getContext("2d");CanvasTextFunctions.enable(_DrawingContext);document.getElementById("taLog").value="";document.getElementById("btnStartOS").focus();if(typeof Glados==="function"){_GLaDOS=new Glados();_GLaDOS.init()}$("#btnStartOS").click(function(){a.startOS($(this))});$("#btnHaltOS").click(function(){a.haltOS($(this))});$("#btnReset").click(function(){a.resetOS($(this))})},hostLog:function(e,c){if(!c){c="?"}var b=_OSclock;var a=new Date().getTime();var d="({ clock:"+b+", source:"+c+", msg:"+e+", now:"+a+" })\n";var f=document.getElementById("taLog");f.value=d+f.value},startOS:function(a){a.disabled=true;document.getElementById("btnHaltOS").disabled=false;document.getElementById("btnReset").disabled=false;document.getElementById("display").focus();_CPU=new Cpu();_CPU.init();_hardwareClockID=setInterval(hostClockPulse,CPU_CLOCK_INTERVAL);_Kernel.bootstrap()},haltOS:function(a){this.hostLog("emergency halt","host");this.hostLog("Attempting Kernel shutdown.","host");_Kernel.shutdown();clearInterval(_hardwareClockID)},resetOS:function(a){location.reload(true)}});var _hardwareClockID=-1;jambOS.host.Device=jambOS.util.createClass({hostClockPulse:function(){_OSclock++;_Kernel.onCPUClockPulse()},hostEnableKeyboardInterrupt:function(){document.addEventListener("keydown",hostOnKeypress,false)},hostDisableKeyboardInterrupt:function(){document.removeEventListener("keydown",hostOnKeypress,false)},hostOnKeypress:function(a){var b=(a.keyCode?a.keyCode:a.which);if(a.target.id==="display"){a.preventDefault();var c=new Array(b,a.shiftKey);_KernelInterruptQueue.enqueue(new Interrupt(KEYBOARD_IRQ,c))}}});function Cpu(){this.PC=0;this.Acc=0;this.Xreg=0;this.Yreg=0;this.Zflag=0;this.isExecuting=false;this.init=function(){this.PC=0;this.Acc=0;this.Xreg=0;this.Yreg=0;this.Zflag=0;this.isExecuting=false};this.cycle=function(){_Kernel.trace("CPU cycle")}}function Interrupt(b,a){this.irq=b;this.params=a}jambOS.OS.Console=jambOS.util.createClass({buffer:"",currentFont:_DefaultFontFamily,currentFontSize:_DefaultFontSize,currentXPosition:0,currentYPosition:_DefaultFontSize,initialize:function(){this.clearScreen();this.resetXY();this.initTaskbar()},initTaskbar:function(){var a=new Date();_TaskbarContext.font="bold 12px Arial";_TaskbarContext.fillText(a.toLocaleString(),16,16);_TaskbarContext.fillText("Status: OS is running...",200,16);window.setInterval(function(){a=new Date();_TaskbarContext.clearRect(16,0,165,20);_TaskbarContext.fillText(a.toLocaleString(),16,16)},1000)},clearScreen:function(){_Canvas.height=480;_DrawingContext.clearRect(0,0,_Canvas.width,_Canvas.height)},resetXY:function(){this.currentXPosition=0;this.currentYPosition=this.currentFontSize+30},handleInput:function(){while(_KernelInputQueue.getSize()>0){var a=_KernelInputQueue.dequeue();if(a===String.fromCharCode(13)){_OsShell.handleInput(this.buffer);this.buffer=""}else{this.putText(a);this.buffer+=a}}},putText:function(b){if(b!==""){_DrawingContext.drawText(this.currentFont,this.currentFontSize,this.currentXPosition,this.currentYPosition,b);var a=_DrawingContext.measureText(this.currentFont,this.currentFontSize,b);this.currentXPosition=this.currentXPosition+a}},advanceLine:function(){this.currentXPosition=0;this.currentYPosition+=_DefaultFontSize+_FontHeightMargin;if((this.currentYPosition+(this.currentFontSize*4))>_Canvas.height){var c=document.createElement("canvas");var a=c.getContext("2d");c.style.diplay="none";c.width=_Canvas.width;c.height=_Canvas.height;var d=_DrawingContext.getImageData(0,0,_Canvas.width,_Canvas.height);a.putImageData(d,0,0);d=a.getImageData(0,0,_Canvas.width,_Canvas.height);_Canvas.height=_Canvas.height+(_Console.currentFontSize*4);_DrawingContext.putImageData(d,0,0);var b=document.getElementById("divConsole");b.scrollTop=b.scrollHeight}}});jambOS.OS.DeviceDriver=jambOS.util.createClass({version:"1.00",status:"unloaded",preemptable:false,driverEntry:null,isr:null});jambOS.OS.DeviceDriverKeyboard=jambOS.util.createClass(jambOS.OS.DeviceDriver,{initialize:function(){},driverEntry:function(){this.status="loaded"},isr:function(d){var n=d[0];var k=d[1];var a=((n>=48)&&(n<=57))||((n>=65)&&(n<=90))||((n>=97)&&(n<=123))||(n===32)||(n===13)||(n===8)||(n===38)||(n===40)||(n>=186)&&(n<=192)||(n>=219&&(n<=222))||n===16||n===20||n===8;if(!a){_Kernel.trapError("Oh bummer, I wish I could have had some use for that key! :(",false);_Console.advanceLine();_StdIn.putText(">")}_Kernel.trace("Key code:"+n+" shifted:"+k);var h="";if(((n>=65)&&(n<=90))||((n>=97)&&(n<=123))){h=String.fromCharCode(n+32);if(k){h=String.fromCharCode(n)}_KernelInputQueue.enqueue(h)}else{if(((n>=48)&&(n<=57))||(n===32)||(n===13)||(n===8)||(n===38)||(n===40)||(n>=186)&&(n<=192)||(n>=219&&(n<=222))){h=String.fromCharCode(n);if(n===49&&k){h="!"}if(n===50&&k){h="@"}if(n===51&&k){h="#"}if(n===52&&k){h="$"}if(n===53&&k){h="%"}if(n===54&&k){h="^"}if(n===55&&k){h="&"}if(n===56&&k){h="*"}if(n===57&&k){h="("}if(n===48&&k){h=")"}if(n===186&&!k){h=";"}else{if(n===186&&k){h=":"}}if(n===187&&!k){h="="}else{if(n===187&&k){h="+"}}if(n===188&&!k){h=","}else{if(n===188&&k){h="<"}}if(n===189&&!k){h="-"}else{if(n===189&&k){h="_"}}if(n===190&&!k){h="."}else{if(n===190&&k){h=">"}}if(n===191&&!k){h="/"}else{if(n===191&&k){h="?"}}if(n===192&&!k){h="`"}else{if(n===192&&k){h="~"}}if(n===219&&!k){h="["}else{if(n===219&&k){h="{"}}if(n===220&&!k){h="\\"}else{if(n===220&&k){h="|"}}if(n===221&&!k){h="]"}else{if(n===221&&k){h="}"}}if(n===222&&!k){h="'"}else{if(n===222&&k){h='"'}}if(n===13){if(_Console.buffer.trim()){_CommandHistory.push(_Console.buffer);_CurrentCommandIndex=_CommandHistory.length-1}}var e="";if(n===38){var l=document.getElementById("divConsole");if(l.scrollTop!==l.scrollHeight){l.scrollTop=l.scrollHeight}if(_CurrentCommandIndex>0){_CurrentCommandIndex-=1}else{_CurrentCommandIndex=0}e=_CommandHistory[_CurrentCommandIndex];var g=_DrawingContext.measureText(_Console.currentFont,_Console.currentFontSize,">");_Console.currentXPosition=g;var i=_Console.currentXPosition;var c=(_Console.currentYPosition-_Console.currentFontSize)-1;var b=500;var m=_Console.currentFontSize+(_Console.currentFontSize/2);_DrawingContext.clearRect(i,c,b,m);if(e&&_CommandHistory.length>0){_Console.buffer=e;_StdIn.putText(e)}}else{if(n===40){var l=document.getElementById("divConsole");if(l.scrollTop!==l.scrollHeight){l.scrollTop=l.scrollHeight}if(_CurrentCommandIndex<_CommandHistory.length){_CurrentCommandIndex+=1}else{_CurrentCommandIndex=_CommandHistory.length-1}e=_CommandHistory[_CurrentCommandIndex];var g=_DrawingContext.measureText(_Console.currentFont,_Console.currentFontSize,">");_Console.currentXPosition=g;var i=_Console.currentXPosition;var c=(_Console.currentYPosition-_Console.currentFontSize)-1;var b=500;var m=_Console.currentFontSize+(_Console.currentFontSize/2);_DrawingContext.clearRect(i,c,b,m);if(e&&_CommandHistory.length>0){_Console.buffer=e;_StdIn.putText(e)}}}if(n===8&&_Console.buffer.length>0){var f=_Console.buffer.charAt(_Console.buffer.length-1);_Console.buffer=_Console.buffer.slice(0,-1);var j=_DrawingContext.measureText(_Console.currentFont,_Console.currentFontSize,f);_Console.currentXPosition-=j;var i=_Console.currentXPosition;var c=(_Console.currentYPosition-_Console.currentFontSize)-1;var b=j;var m=_Console.currentFontSize+(_Console.currentFontSize/2);_DrawingContext.clearRect(i,c,b,m)}else{if(n!==38&&n!==40){_KernelInputQueue.enqueue(h)}}}}}});function Queue(){this.q=new Array();this.getSize=function(){return this.q.length};this.isEmpty=function(){return(this.q.length==0)};this.enqueue=function(a){this.q.push(a)};this.dequeue=function(){var a=null;if(this.q.length>0){a=this.q.shift()}return a};this.toString=function(){var b="";for(var a in this.q){b+="["+this.q[a]+"] "}return b}}jambOS.OS.Kernel=jambOS.util.createClass({keyboardDrive:null,initialize:function(){krnInterruptHandler=this.interruptHandler},bootstrap:function(){_Control.hostLog("bootstrap","host");_KernelInterruptQueue=new Queue();_KernelBuffers=new Array();_KernelInputQueue=new Queue();_Console=new jambOS.OS.Console();_StdIn=_Console;_StdOut=_Console;this.trace("Loading the keyboard device driver.");this.keyboardDriver=new jambOS.OS.DeviceDriverKeyboard();this.keyboardDriver.driverEntry();this.trace(this.keyboardDriver.status);this.trace("Enabling the interrupts.");this.enableInterupts();this.trace("Creating and Launching the shell.");_OsShell=new Shell();_OsShell.init();if(_GLaDOS){_GLaDOS.afterStartup()}},shutdown:function(){this.trace("begin shutdown OS");this.trace("Disabling the interrupts.");this.disableInterupts();this.trace("end shutdown OS")},onCPUClockPulse:function(){if(_KernelInterruptQueue.getSize()>0){var a=_KernelInterruptQueue.dequeue();this.interruptHandler(a.irq,a.params)}else{if(_CPU.isExecuting){_CPU.cycle()}else{this.trace("Idle")}}},enableInterupts:function(){hostEnableKeyboardInterrupt()},disableInterupts:function(){hostDisableKeyboardInterrupt()},interruptHandler:function(b,c){var a=_Kernel;a.trace("Handling IRQ~"+b);switch(b){case TIMER_IRQ:_Kernal.timerISR();break;case KEYBOARD_IRQ:a.keyboardDriver.isr(c);_StdIn.handleInput();break;default:a.trapError("Invalid Interrupt Request. irq="+b+" params=["+c+"]")}},imerISRL:function(){},trace:function(a){if(_Trace){if(a==="Idle"){if(_OSclock%10==0){_Control.hostLog(a,"OS")}}else{_Control.hostLog(a,"OS")}}},trapError:function(g,d){d=typeof d==="undefined"?true:d;_Control.hostLog("OS ERROR - TRAP: "+g);var f=_DrawingContext.measureText(_Console.currentFont,_Console.currentFontSize,">");_Console.currentXPosition=f;var e=_Console.currentXPosition;var c=(_Console.currentYPosition-_Console.currentFontSize)-1;var b=500;var a=_Console.currentFontSize+(_Console.currentFontSize/2);_DrawingContext.clearRect(e,c,b,a);_DrawingContext.fillStyle="blue";_DrawingContext.font="bold 12px Arial";_DrawingContext.fillText("OS ERROR - TRAP: => "+g,e,_Console.currentYPosition);if(d){this.shutdown()}}});